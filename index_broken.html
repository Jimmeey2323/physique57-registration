<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7389670XJC"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-7389670XJC');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physique 57 - New Member Registration</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --p57-primary: #6366f1;
            --p57-primary-dark: #4f46e5;
            --p57-secondary: #8b5cf6;
            --p57-white: #FFFFFF;
            --p57-gray-50: #f9fafb;
            --p57-gray-100: #f3f4f6;
            --p57-gray-200: #e5e7eb;
            --p57-gray-300: #d1d5db;
            --p57-gray-400: #9ca3af;
            --p57-gray-500: #6b7280;
            --p57-gray-600: #4b5563;
            --p57-gray-700: #374151;
            --p57-gray-800: #1f2937;
            --p57-gray-900: #111827;
            --p57-success: #10b981;
            --p57-error: #ef4444;
            --p57-warning: #f59e0b;
            --background-gradient: linear-gradient(135deg, #ffffff 0%, #f8fafc 30%, #f1f5f9 60%, #e2e8f0 100%);
            --card-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --border-radius: 24px;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--background-gradient);
            min-height: 100vh;
            color: var(--p57-gray-800);
            background-attachment: fixed;
            overflow-y: auto;
        }
        
        .form-overlay {
            position: relative;
            top: auto;
            left: auto;
            transform: none;
            background-color: transparent;
            z-index: 1000;
            width: 100%;
            max-width: 520px;
            margin: 40px auto;
            padding: 20px;
            box-sizing: border-box;
            animation: fadeInScale 0.6s ease-out;
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .form-container {
            background: rgba(255, 255, 255, 0.98);
            padding: 50px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            min-height: auto;
            position: relative;
            backdrop-filter: blur(20px);
        }
        
        .form-container:hover {
            transform: translateY(-4px);
            box-shadow: 0 32px 64px -12px rgba(0, 0, 0, 0.35);
        }
        
        .logo-container {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .logo-container img {
            max-width: 80px;
            height: auto;
            filter: none;
            transition: all 0.3s ease;
        }
        
        .brand-title {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--p57-primary), var(--p57-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 8px;
            letter-spacing: -1px;
            text-transform: uppercase;
        }
        
        .brand-subtitle {
            font-size: 16px;
            font-weight: 400;
            color: var(--p57-gray-600);
            text-align: center;
            margin-bottom: 30px;
            letter-spacing: 0.5px;
        }
        
        .screen-title {
            text-align: center;
            font-size: 26px;
            font-weight: 600;
            color: var(--p57-gray-900);
            margin-bottom: 16px;
            line-height: 1.2;
        }
        
        .screen-subtitle {
            text-align: center;
            font-size: 16px;
            color: var(--p57-gray-600);
            margin-bottom: 32px;
            line-height: 1.5;
            font-weight: 400;
        }
        
        #main-form {
            padding: 0;
        }
        
        #main-form label, #main-form p {
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--p57-gray-700);
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0;
        }
        
        #main-form input[type="text"], 
        #main-form input[type="email"], 
        #main-form input[type="tel"], 
        #main-form select,
        .search-input {
            width: 100%;
            padding: 16px 20px;
            margin-bottom: 24px;
            border: 2px solid var(--p57-gray-200);
            border-radius: 16px;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
            font-size: 15px;
            font-weight: 400;
            transition: all 0.3s ease;
            background: var(--p57-gray-50);
            color: var(--p57-gray-900);
        }
        
        #main-form input[type="text"]:focus, 
        #main-form input[type="email"]:focus, 
        #main-form input[type="tel"]:focus, 
        #main-form select:focus,
        .search-input:focus {
            outline: none;
            border-color: var(--p57-primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            background: var(--p57-white);
            transform: translateY(-1px);
        }
        
        button {
            padding: 18px 28px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            border: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: none;
            letter-spacing: 0;
        }
        
        button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        button:hover:before {
            left: 100%;
        }
        
        button.submit {
            background: linear-gradient(135deg, var(--p57-primary), var(--p57-primary-dark));
            color: var(--p57-white);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
            font-weight: 600;
            border-radius: 16px;
        }
        
        button.submit:hover {
            background: linear-gradient(135deg, var(--p57-primary-dark), var(--p57-secondary));
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.4);
        }
        
        button.submit:active {
            transform: translateY(0);
        }
        
        button.secondary {
            background: var(--p57-white);
            color: var(--p57-gray-700);
            border: 2px solid var(--p57-gray-200);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-radius: 16px;
        }
        
        button.secondary:hover {
            background: var(--p57-gray-50);
            border-color: var(--p57-primary);
            color: var(--p57-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.15);
        }
        
        button.purchase {
            background: linear-gradient(135deg, var(--p57-success), #059669);
            color: white;
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
            border-radius: 16px;
        }
        
        button.purchase:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(16, 185, 129, 0.4);
        }
        
        button.whatsapp {
            background: linear-gradient(135deg, #25d366, #128c7e);
            color: white;
            box-shadow: 0 10px 25px rgba(37, 211, 102, 0.3);
            border-radius: 16px;
        }
        
        button.whatsapp:hover {
            background: linear-gradient(135deg, #128c7e, #0d7377);
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(37, 211, 102, 0.4);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .required {
            color: var(--p57-error);
            font-weight: 700;
        }
        
        .success-message {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            color: var(--p57-success);
            padding: 20px 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            font-size: 15px;
            border: 2px solid rgba(16, 185, 129, 0.2);
            text-align: center;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
        }
        
        .error-message {
            background: linear-gradient(135deg, #fef2f2, #fecaca);
            color: var(--p57-error);
            padding: 20px 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            font-size: 15px;
            border: 2px solid rgba(239, 68, 68, 0.2);
            text-align: center;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.1);
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Progress indicator */
        .progress-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .progress-step {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--p57-gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--p57-gray-500);
            font-weight: 600;
            font-size: 13px;
            margin: 0 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .progress-step.active {
            background: var(--p57-primary);
            color: var(--p57-white);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
            transform: scale(1.1);
        }
        
        .progress-step.completed {
            background: var(--p57-success);
            color: var(--p57-white);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }
        
        @media (max-width: 600px) {
            body {
                padding: 16px;
            }
            
            .form-overlay {
                margin: 20px auto;
                padding: 0;
            }
            
            .form-container {
                padding: 32px 24px;
                border-radius: 20px;
            }
            
            .brand-title {
                font-size: 28px;
            }
            
            .screen-title {
                font-size: 22px;
            }
            
            .progress-step {
                width: 32px;
                height: 32px;
                font-size: 12px;
                margin: 0 8px;
            }
            
            button {
                padding: 16px 24px;
                font-size: 14px;
            }
        }
    </style>

    <!-- Snap Pixel Code -->
    <script type='text/javascript'>
        (function(e, t, n) {
            if (e.snaptr) return;
            var a = e.snaptr = function() {
                a.handleRequest ? a.handleRequest.apply(a, arguments) : a.queue.push(arguments)
            };
            a.queue = [];
            var s = 'script';
            r = t.createElement(s);
            r.async = !0;
            r.src = n;
            var u = t.getElementsByTagName(s)[0];
            u.parentNode.insertBefore(r, u);
        })(window, document, 'https://sc-static.net/scevent.min.js');

        snaptr('init', '5217a3a7-5f50-4c98-803c-a73c9f05737e', {
            'user_email': '__INSERT_USER_EMAIL__'
        });

        snaptr('track', 'PAGE_VIEW');
    </script>
    <!-- End Snap Pixel Code -->

    <!-- Meta Pixel script -->
    <script>
        !function(f, b, e, v, n, t, s) {
            if (f.fbq) return;
            n = f.fbq = function() {
                n.callMethod ? n.callMethod.apply(n, arguments) : n.queue.push(arguments)
            };
            if (!f._fbq) f._fbq = n;
            n.push = n;
            n.loaded = !0;
            n.version = '2.0';
            n.queue = [];
            t = b.createElement(e);
            t.async = !0;
            t.src = v;
            s = b.getElementsByTagName(e)[0];
            s.parentNode.insertBefore(t, s)
        }(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '527819981439695');
        fbq('track', 'PageView');
    </script>
    <noscript>
        <img src="https://www.facebook.com/tr?id=527819981439695&ev=PageView&noscript=1" />
    </noscript>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-809104648"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'AW-809104648');
    </script>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WHBZMFXL"
            height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="form-overlay" id="form-overlay">
        <div class="form-container">
            <!-- Main Registration Form (First Screen) -->
            <form id="main-form">
                <div class="logo-container">
                    <img src="logo.jpeg" alt="Physique 57">
                </div>
                
                <h1 class="brand-title">PHYSIQUE 57</h1>
                <p class="brand-subtitle">Transform Your Body, Transform Your Life</p>
                
                <div class="progress-indicator">
                    <div class="progress-step active">1</div>
                    <div class="progress-step">2</div>
                    <div class="progress-step">3</div>
                </div>
                
                <h2 class="screen-title">Let's Get Started</h2>
                
                <div id="form-messages"></div>

                <label for="firstName">First Name <span class="required">*</span></label>
                <input type="text" id="firstName" name="firstName" required>

                <label for="lastName">Last Name <span class="required">*</span></label>
                <input type="text" id="lastName" name="lastName" required>

                <label for="email">Email Address <span class="required">*</span></label>
                <input type="email" id="email" name="email" required>

                <label for="phoneNumber">Phone Number <span class="required">*</span></label>
                <input type="tel" id="phoneNumber" name="phoneNumber" required placeholder="+91XXXXXXXXXX" oninput="formatPhoneNumber()">

                <label for="center">Select Studio Location <span class="required">*</span></label>
                <select id="center" name="center" required>
                    <option value="" disabled selected>Choose Your Preferred Studio</option>
                    <option value="Supreme Headquarters, Bandra">Supreme Headquarters, Bandra</option>
                    <option value="Kwality House, Kemps Corner">Kwality House, Kemps Corner</option>
                    <option value="Kenkere House, Bengaluru">Kenkere House, Bengaluru</option>
                </select>

                <!-- Hidden fields -->
                <input type="hidden" id="classType" name="classType" value="Barre 57">
                <input type="hidden" id="preferredTime" name="preferredTime" value="Any">

                <button type="submit" class="submit" style="width: 100%;">Continue to Next Step</button>
            </form>

            <!-- Member Status Check (Second Screen) -->
            <div id="member-status-screen" class="hidden">
                <div class="logo-container">
                    <img src="logo.jpeg" alt="Physique 57">
                </div>
                
                <h1 class="brand-title">PHYSIQUE 57</h1>
                
                <div class="progress-indicator">
                    <div class="progress-step completed">✓</div>
                    <div class="progress-step active">2</div>
                    <div class="progress-step">3</div>
                </div>
                
                <h2 class="screen-title">Membership Status</h2>
                <p class="screen-subtitle">Do you have an active membership with Physique 57?</p>

                <div style="display: flex; gap: 15px; margin-bottom: 30px;">
                    <button type="button" id="existing-member-btn" class="submit" style="flex: 1;">
                        Yes, I'm a Member
                    </button>
                    <button type="button" id="new-member-btn" class="secondary" style="flex: 1;">
                        No, I'm New
                    </button>
                </div>
                
                <button type="button" id="back-to-form-btn" class="secondary" style="width: 100%;">Back</button>
            </div>

            <!-- Existing Member Search (Third Screen Option A) -->
            <div id="member-search-screen" class="hidden">
                <div class="logo-container">
                    <img src="logo.jpeg" alt="Physique 57">
                </div>
                
                <h1 class="brand-title">PHYSIQUE 57</h1>
                
                <div class="progress-indicator">
                    <div class="progress-step completed">✓</div>
                    <div class="progress-step completed">✓</div>
                    <div class="progress-step active">3</div>
                </div>
                
                <h2 class="screen-title">Find Your Membership</h2>
                <p class="screen-subtitle">Enter your registered email or phone number</p>
                
                <label for="searchInput">Email or Phone Number <span class="required">*</span></label>
                <input type="text" id="searchInput" name="searchInput" class="search-input" placeholder="Enter email or phone number" required>
                
                <button type="button" id="search-member-btn" class="submit" style="width: 100%; margin-bottom: 15px;">
                    Search Membership
                </button>
                
                <div id="search-results" class="hidden">
                    <div id="member-info"></div>
                    <div id="membership-status"></div>
                </div>
                
                <button type="button" id="back-to-form-from-search-btn" class="secondary" style="width: 100%;">
                    ← Back to Form
                </button>
            </div>

            <!-- New Member Options (Third Screen Option B) -->
            <div id="new-member-screen" class="hidden">
                <div class="logo-container">
                    <img src="logo.jpeg" alt="Physique 57">
                </div>
                
                <h1 class="brand-title">PHYSIQUE 57</h1>
                
                <div class="progress-indicator">
                    <div class="progress-step completed">✓</div>
                    <div class="progress-step completed">✓</div>
                    <div class="progress-step active">3</div>
                </div>
                
                <h2 class="screen-title">Welcome to Physique 57!</h2>
                <p class="screen-subtitle">Ready to transform your body and mind? Let's get you started with a membership.</p>
                
                <div class="success-message">
                    Your registration has been submitted! Our team will reach out to you shortly to complete the process.
                </div>

                <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px;">
                    <button type="button" id="purchase-membership-btn" class="purchase" style="width: 100%;">
                        Purchase Membership Online
                    </button>
                    
                    <button type="button" id="whatsapp-contact-btn" class="whatsapp" style="width: 100%;">
                        Chat with Our Team
                    </button>
                </div>
                
                <button type="button" id="back-to-form-from-new-btn" class="secondary" style="width: 100%;">
                    ← Back to Form
                </button>
            </div>

            <!-- Success/Error Messages Screen -->
            <div id="message-screen" class="hidden">
                <div class="logo-container">
                    <img src="logo.jpeg" alt="Physique 57">
                </div>
                
                <h1 class="brand-title">PHYSIQUE 57</h1>
                
                <div id="message-content"></div>
                
                <button type="button" id="close-message-btn" class="secondary" style="width: 100%;">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Google OAuth credentials for Sheets integration
        const GOOGLE_CLIENT_ID = '581427527932-f6d4m2ollrro6ttnid0g69t7crppbdt7.apps.googleusercontent.com';
        const GOOGLE_CLIENT_SECRET = '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';
        const GOOGLE_REFRESH_TOKEN = '1//04fQo2Xgv3I26CgYIARAAGAQSNwF-L9IrlezyhDGLxIDmQkDNZgOo2WmH54p5rwqHA6D2VTjLvLAefriciqMVG99okFBle4QYMLo';
        const SPREADSHEET_ID = '1zUTUmjTkBKf7JNkQEnr13mtyIPRq4nRSqSvk2wRMgM0';
        const SHEET_NAME = 'Signups';
        
        // Momence API Configuration
        const MOMENCE_BASE_URL = 'https://api.momence.com/api/v2';
        const MOMENCE_BASIC_AUTH = 'Basic YXBpLTEzNzUyLUtYRTBPRFVQR3BTdkVrR1E6dlpPWkRGSHk0dEtOeWYzOHpvZ0JtQnRZSElSaTJldVo=';
        const MOMENCE_USERNAME = 'physique57mumbai1@gmail.com';
        const MOMENCE_PASSWORD = 'Jimmeey@123';
        const TAG_ID = '230343';
        const PURCHASE_PAGE_URL = 'https://momence.com/m/69064';
        const WHATSAPP_NUMBER = '+918779292745';
        const GOOGLE_SHEET_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxVNIARfFs0R_KHCxNn_rOCAWI2R-pv1FaLB5IIsI8RcFWDnbFaZUgUKxA--69TMaJ0/exec';
        
        let googleAccessToken = null;
        let momenceAccessToken = null;
        let momenceRefreshToken = null;
        let isExistingMember = false;
        let currentMembershipData = null;
        let formData = {};
        let hasLoggedToSheets = false;
        
        // Get Google Sheets access token
        async function getGoogleAccessToken() {
            try {
                const response = await fetch('https://oauth2.googleapis.com/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        client_id: GOOGLE_CLIENT_ID,
                        client_secret: GOOGLE_CLIENT_SECRET,
                        refresh_token: GOOGLE_REFRESH_TOKEN,
                        grant_type: 'refresh_token'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                googleAccessToken = data.access_token;
                return googleAccessToken;
            } catch (error) {
                console.error('Error getting access token:', error);
                return null;
            }
        }
        
        // Authenticate with Momence API using correct method
        async function authenticate() {
            try {
                const authResponse = await fetch(
                    "https://api.momence.com/api/v2/auth/token",
                    {
                        method: "POST",
                        headers: {
                            accept: "application/json",
                            authorization: MOMENCE_BASIC_AUTH,
                            "content-type": "application/x-www-form-urlencoded",
                        },
                        body: new URLSearchParams({
                            grant_type: "password",
                            username: MOMENCE_USERNAME,
                            password: MOMENCE_PASSWORD,
                        }),
                    }
                );

                if (!authResponse.ok) {
                    throw new Error(`Authentication failed: ${authResponse.status}`);
                }

                const authData = await authResponse.json();
                momenceAccessToken = authData.access_token;
                momenceRefreshToken = authData.refreshToken;

                console.log('Momence authentication successful');
                return { success: true };
            } catch (error) {
                console.error("Error during authentication:", error);
                return { success: false, error: error.message };
            }
        }

        // Refresh Momence access token
        async function refreshAccessToken() {
            try {
                const refreshResponse = await fetch(
                    "https://api.momence.com/api/v2/auth/token",
                    {
                        method: "POST",
                        headers: {
                            accept: "application/json",
                            authorization: MOMENCE_BASIC_AUTH,
                            "content-type": "application/x-www-form-urlencoded",
                        },
                        body: new URLSearchParams({
                            grant_type: "refresh_token",
                            refresh_token: momenceRefreshToken,
                        }),
                    }
                );

                if (!refreshResponse.ok) {
                    throw new Error(`Token refresh failed: ${refreshResponse.status}`);
                }

                const refreshData = await refreshResponse.json();
                momenceAccessToken = refreshData.access_token;
                momenceRefreshToken = refreshData.refreshToken;

                console.log('Momence token refreshed successfully');
            } catch (error) {
                console.error("Error refreshing access token:", error);
                // If refresh fails, try to authenticate again
                await authenticate();
            }
        }
        
        // Add tag to member account
        async function addMemberTag(memberId) {
            try {
                if (!momenceAccessToken) {
                    const authResult = await authenticate();
                    if (!authResult.success) {
                        throw new Error('Failed to authenticate');
                    }
                }
                
                const url = `${MOMENCE_BASE_URL}/host/members/${memberId}/tags/${TAG_ID}`;
                
                let response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'accept': 'application/json',
                        'authorization': `Bearer ${momenceAccessToken}`
                    }
                });
                
                if (response.status === 401) {
                    await refreshAccessToken();
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'accept': 'application/json',
                            'authorization': `Bearer ${momenceAccessToken}`
                        }
                    });
                }
                
                if (response.ok) {
                    console.log('Successfully added tag to member:', memberId);
                    return true;
                } else {
                    console.error('Failed to add tag to member:', memberId, response.status);
                    return false;
                }
            } catch (error) {
                console.error('Error adding member tag:', error);
                return false;
            }
        }
        
        // Log to Google Sheets - Update existing row if email exists, otherwise create new
        async function logToGoogleSheets(data, isComplete = true) {
            try {
                if (!googleAccessToken) {
                    await getGoogleAccessToken();
                }
                
                if (!googleAccessToken) {
                    console.error('Failed to get access token');
                    return;
                }
                
                // First, check if the sheet is empty and needs headers
                await ensureSheetHeaders();
                
                const timestamp = new Date().toLocaleString('en-IN', {
                    timeZone: 'Asia/Kolkata',
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                // Check if email already exists in the sheet
                const existingRowIndex = await findRowByEmail(data.email);
                
                const rowData = [
                    timestamp,
                    data.firstName || '',
                    data.lastName || '',
                    data.email || '',
                    data.phoneNumber || '',
                    data.center || '',
                    data.memberType || '',
                    data.membershipStatus || '',
                    isComplete ? 'Complete' : 'Incomplete',
                    data.notes || '',
                    data.membershipDetails || '',
                    data.membershipName || '',
                    data.membershipType || '',
                    data.membershipStartDate || '',
                    data.membershipEndDate || '',
                    data.membershipCreditsLeft || '',
                    data.membershipIsFrozen || ''
                ];
                
                if (existingRowIndex !== -1) {
                    // Update existing row
                    const range = `${SHEET_NAME}!A${existingRowIndex + 1}:Q${existingRowIndex + 1}`;
                    const requestBody = {
                        values: [rowData]
                    };
                    
                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?valueInputOption=RAW`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${googleAccessToken}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestBody)
                        }
                    );
                    
                    if (!response.ok) {
                        throw new Error(`Google Sheets update error: ${response.status}`);
                    }
                    
                    console.log('Successfully updated existing row in Google Sheets:', data);
                } else {
                    // Create new row
                    const requestBody = {
                        values: [rowData]
                    };
                    
                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS`,
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${googleAccessToken}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestBody)
                        }
                    );
                    
                    if (!response.ok) {
                        throw new Error(`Google Sheets append error: ${response.status}`);
                    }
                    
                    console.log('Successfully added new row to Google Sheets:', data);
                }
                
            } catch (error) {
                console.error('Error logging to Google Sheets:', error);
            }
        }
        
        // Find row index by email in Google Sheets
        async function findRowByEmail(email) {
            try {
                if (!email) return -1;
                
                // Get all data from the sheet
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}!A:Q`,
                    {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`,
                            'Content-Type': 'application/json',
                        }
                    }
                );
                
                if (!response.ok) {
                    console.error('Failed to fetch sheet data:', response.status);
                    return -1;
                }
                
                const data = await response.json();
                if (!data.values || data.values.length <= 1) {
                    return -1; // No data rows (only headers or empty)
                }
                
                // Find row with matching email (column D, index 3)
                for (let i = 1; i < data.values.length; i++) {
                    const row = data.values[i];
                    if (row[3] && row[3].toLowerCase() === email.toLowerCase()) {
                        return i; // Return 0-based index
                    }
                }
                
                return -1; // Not found
            } catch (error) {
                console.error('Error finding row by email:', error);
                return -1;
            }
        }
        
        // Ensure Google Sheet has proper headers
        async function ensureSheetHeaders() {
            try {
                // Check if sheet has data
                const checkResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}!A1:J1`,
                    {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`,
                            'Content-Type': 'application/json',
                        }
                    }
                );
                
                if (!checkResponse.ok) {
                    throw new Error(`Failed to check sheet headers: ${checkResponse.status}`);
                }
                
                const checkData = await checkResponse.json();
                
                // If sheet is empty or doesn't have proper headers, add them
                if (!checkData.values || checkData.values.length === 0 || 
                    !checkData.values[0] || checkData.values[0][0] !== 'Timestamp') {
                    
                    const headers = [
                        'Timestamp',
                        'First Name', 
                        'Last Name',
                        'Email',
                        'Phone Number',
                        'Center',
                        'Member Type',
                        'Membership Status',
                        'Submission Status',
                        'Notes',
                        'Membership Details',
                        'Membership Name',
                        'Membership Type',
                        'Membership Start Date',
                        'Membership End Date',
                        'Credits Left',
                        'Is Frozen'
                    ];
                    
                    const headerRequestBody = {
                        values: [headers]
                    };
                    
                    // Clear the sheet first if it has wrong headers
                    if (checkData.values && checkData.values.length > 0) {
                        await fetch(
                            `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}:clear`,
                            {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${googleAccessToken}`,
                                    'Content-Type': 'application/json',
                                }
                            }
                        );
                    }
                    
                    // Add headers
                    const headerResponse = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}!A1:append?valueInputOption=RAW`,
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${googleAccessToken}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(headerRequestBody)
                        }
                    );
                    
                    if (!headerResponse.ok) {
                        throw new Error(`Failed to add headers: ${headerResponse.status}`);
                    }
                    
                    console.log('Headers added to Google Sheet');
                }
            } catch (error) {
                console.error('Error ensuring sheet headers:', error);
            }
        }
        
        // Show/Hide screens
        function showScreen(screenId) {
            const screens = ['main-form', 'member-status-screen', 'member-search-screen', 'new-member-screen', 'message-screen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }
        
        // Show message screen
        function showMessage(type, title, message, hasActions = false) {
            const messageContent = document.getElementById('message-content');
            let messageClass = type === 'success' ? 'success-message' : 'error-message';
            
            messageContent.innerHTML = `
                <div class="progress-indicator">
                    <div class="progress-step completed">✓</div>
                    <div class="progress-step completed">✓</div>
                    <div class="progress-step ${type === 'success' ? 'completed' : 'active'}">${type === 'success' ? '✓' : '3'}</div>
                </div>
                <h2 class="screen-title">${title}</h2>
                <div class="${messageClass}">${message}</div>
                ${hasActions ? `
                    <div style="display: flex; flex-direction: column; gap: 15px; margin: 30px 0;">
                        <button type="button" id="purchase-membership-btn2" class="purchase" style="width: 100%;">
                            Purchase Membership Online
                        </button>
                        <button type="button" id="whatsapp-contact-btn2" class="whatsapp" style="width: 100%;">
                            Chat with Our Team
                        </button>
                    </div>
                ` : ''}
            `;
            
            showScreen('message-screen');
            
            if (hasActions) {
                document.getElementById('purchase-membership-btn2').onclick = () => window.open(PURCHASE_PAGE_URL, '_blank');
                document.getElementById('whatsapp-contact-btn2').onclick = openWhatsApp;
            }
        }
        
        // Open WhatsApp
        function openWhatsApp() {
            const message = `Hi! I'm interested in Physique 57 membership. My details:\n\nName: ${formData.firstName || ''} ${formData.lastName || ''}\nEmail: ${formData.email || ''}\nPhone: ${formData.phoneNumber || ''}\nPreferred Studio: ${formData.center || ''}\n\nCould you please help me with membership options?`;
            const whatsappURL = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
            window.open(whatsappURL, '_blank');
        }
        
        // Format phone number
        function formatPhoneNumber() {
            let input = document.getElementById('phoneNumber');
            let number = input.value.replace(/\D/g, '');
            const countryCodes = ['1', '33', '971', '44', '63', '65', '34'];

            function startsWithCode(num) {
                return countryCodes.some(code => num.startsWith(code));
            }

            if (number.length === 10 && !startsWithCode(number)) {
                input.value = '+91' + number;
            } else if (startsWithCode(number)) {
                input.value = '+' + number;
            } else {
                input.value = '+' + number;
            }
        }
        

        // Search for member using correct Momence API
        async function searchMember() {
            const searchInput = document.getElementById('searchInput').value.trim();
            const searchButton = document.getElementById('search-member-btn');
            const searchResults = document.getElementById('search-results');
            
            if (!searchInput) {
                alert('Please enter email or phone number');
                return;
            }

            searchButton.disabled = true;
            searchButton.textContent = 'Searching...';
            searchResults.classList.add('hidden');

            try {
                // Authenticate first if no token
                if (!momenceAccessToken) {
                    const authResult = await authenticate();
                    if (!authResult.success) {
                        throw new Error('Failed to authenticate with Momence API');
                    }
                }

                console.log('Searching for member with:', searchInput);
                
                // Step 1: Get member ID using email
                let memberResponse = await fetch(
                    `https://api.momence.com/api/v2/host/members?page=0&pageSize=100&sortOrder=DESC&sortBy=firstSeenAt&query=${encodeURIComponent(searchInput)}`,
                    {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Authorization': `Bearer ${momenceAccessToken}`
                        }
                    }
                );
                
                // Handle 401 by refreshing token
                if (memberResponse.status === 401) {
                    await refreshAccessToken();
                    memberResponse = await fetch(
                        `https://api.momence.com/api/v2/host/members?page=0&pageSize=100&sortOrder=DESC&sortBy=firstSeenAt&query=${encodeURIComponent(searchInput)}`,
                        {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Authorization': `Bearer ${momenceAccessToken}`
                            }
                        }
                    );
                }
                
                console.log('Member search response status:', memberResponse.status);
                
                if (!memberResponse.ok) {
                    const errorText = await memberResponse.text();
                    console.error('Member search API error:', errorText);
                    throw new Error(`Member search failed: ${memberResponse.status} - ${errorText}`);
                }
                
                const memberData = await memberResponse.json();
                console.log('Member search response:', memberData);
                
                let member = null;
                if (memberData.payload && memberData.payload.length > 0) {
                    // Find exact email match
                    member = memberData.payload.find(m => 
                        m.email && m.email.toLowerCase() === searchInput.toLowerCase()
                    );
                    if (!member) {
                        member = memberData.payload[0]; // Fallback to first result
                    }
                }
                
                if (!member) {
                    // User is not a member, show new member screen
                    formData.memberType = 'New Member';
                    formData.membershipStatus = 'None';
                    formData.notes = 'No existing membership found';
                    
                    showScreen('new-member-screen');
                    return;
                }

                console.log('Found member:', member);
                
                // Step 2: Get active memberships using member ID
                let membershipResponse = await fetch(
                    `https://api.momence.com/api/v2/host/members/${member.id}/bought-memberships/active?page=0&pageSize=200&includeFrozen=true`,
                    {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Authorization': `Bearer ${momenceAccessToken}`
                        }
                    }
                );
                
                // Handle 401 by refreshing token
                if (membershipResponse.status === 401) {
                    await refreshAccessToken();
                    membershipResponse = await fetch(
                        `https://api.momence.com/api/v2/host/members/${member.id}/bought-memberships/active?page=0&pageSize=200&includeFrozen=true`,
                        {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Authorization': `Bearer ${momenceAccessToken}`
                            }
                        }
                    );
                }
                
                console.log('Membership response status:', membershipResponse.status);
                
                let membershipData = null;
                let hasActiveMembership = false;
                let membershipDetails = '';
                
                if (membershipResponse.ok) {
                    membershipData = await membershipResponse.json();
                    console.log('Membership response:', membershipData);
                    
                    if (membershipData.payload && membershipData.payload.length > 0) {
                        hasActiveMembership = true;
                        const activeMembership = membershipData.payload[0];
                        
                        // Extract membership details
                        membershipDetails = {
                            membershipName: activeMembership.membership?.name || 'Unknown',
                            membershipType: activeMembership.type || 'Unknown',
                            membershipStartDate: activeMembership.startDate || '',
                            membershipEndDate: activeMembership.endDate || '',
                            membershipCreditsLeft: activeMembership.eventCreditsLeft || activeMembership.usageLimitForSessions - activeMembership.usedSessions || '',
                            membershipIsFrozen: activeMembership.isFrozen ? 'Yes' : 'No',
                            membershipDetails: `${activeMembership.membership?.name || 'Unknown'} - Credits Left: ${activeMembership.eventCreditsLeft || (activeMembership.usageLimitForSessions - activeMembership.usedSessions) || 'Unlimited'}`
                        };
                    }
                } else {
                    console.error('Failed to fetch membership data:', await membershipResponse.text());
                }
                
                // Update form data with found member info
                formData.firstName = member.firstName || formData.firstName;
                formData.lastName = member.lastName || formData.lastName;
                formData.email = member.email || formData.email;
                formData.phoneNumber = member.phoneNumber || formData.phoneNumber;
                formData.memberType = 'Existing Member';
                formData.membershipStatus = hasActiveMembership ? 'Active' : 'Inactive';
                
                // Add membership details to formData
                if (membershipDetails) {
                    Object.assign(formData, membershipDetails);
                }
                
                currentMembershipData = member;
                
                if (hasActiveMembership) {
                    // Show membership details with Continue button
                    const endDate = new Date(membershipDetails.membershipEndDate).toLocaleDateString();
                    
                    showMessage('success', 'Membership Found!', 
                        `<div style="text-align: left; margin: 20px 0;">
                            <p style="margin: 5px 0;"><strong>Plan:</strong> ${membershipDetails.membershipName}</p>
                            <p style="margin: 5px 0;"><strong>Type:</strong> ${membershipDetails.membershipType}</p>
                            <p style="margin: 5px 0;"><strong>Start Date:</strong> ${new Date(membershipDetails.membershipStartDate).toLocaleDateString()}</p>
                            <p style="margin: 5px 0;"><strong>End Date:</strong> ${endDate}</p>
                            <p style="margin: 5px 0;"><strong>Credits Left:</strong> ${membershipDetails.membershipCreditsLeft || 'Unlimited'}</p>
                            <p style="margin: 5px 0;"><strong>Status:</strong> ${membershipDetails.membershipIsFrozen === 'Yes' ? 'Frozen' : 'Active'}</p>
                        </div>
                        <button type="button" id="continue-registration-btn" class="submit" style="width: 100%; margin-top: 20px;">
                            Continue to Registration
                        </button>`,
                        false
                    );
                    
                    // Add event listener for the continue button
                    setTimeout(() => {
                        document.getElementById('continue-registration-btn').addEventListener('click', async () => {
                            formData.notes = 'Active membership confirmed, user clicked continue';
                            await logToGoogleSheets(formData, true);
                            hasLoggedToSheets = true;
                            showScreen('main-form');
                        });
                    }, 100);
                } else {
                    // Log the member even if membership is inactive
                    formData.notes = 'Existing member with inactive/expired subscription';
                    await logToGoogleSheets(formData, true);
                    hasLoggedToSheets = true;
                    
                    showMessage('error', 'Membership Required', 
                        'Your account was found, but you don\'t have an active membership. Please purchase a membership to continue.',
                        true
                    );
                }

            } catch (error) {
                console.error('Member search error:', error);
                
                // Log the error and treat as new member
                formData.memberType = 'Unknown';
                formData.membershipStatus = 'Search Error';
                formData.notes = `Search failed: ${error.message}`;
                await logToGoogleSheets(formData, true);
                hasLoggedToSheets = true;
                
                showMessage('error', 'Search Error', 
                    'Unable to verify your membership status. Please contact our team or proceed as a new member.',
                    true
                );
            } finally {
                searchButton.disabled = false;
                searchButton.textContent = 'Search Membership';
            }
        }


        // Submit registration to Momence webhooks
        async function submitRegistration() {
            try {
                let memberId = null;
                
                if (isExistingMember && currentMembershipData) {
                    // For existing members, we already have their member ID
                    memberId = currentMembershipData.id || (formData.memberId || null);
                    console.log('Existing member submission for member ID:', memberId);
                } else {
                    // For new members, submit to Momence to create the lead/member
                    console.log('New member submission');
                    
                    // Determine webhook parameters based on location
                    let webhookUrl, token, sourceId;
                    if (formData.center === 'Kenkere House, Bengaluru') {
                        webhookUrl = 'https://api.momence.com/integrations/customer-leads/33905/collect';
                        token = 'qy71rOk8en';
                        sourceId = '147133';
                    } else {
                        // Default Mumbai parameters
                        webhookUrl = 'https://api.momence.com/integrations/customer-leads/13752/collect';
                        token = 'DOjMVL37Q5';
                        sourceId = '147016';
                    }
                    
                    const dataForMomence = {
                        token: token,
                        sourceId: sourceId,
                        firstName: formData.firstName,
                        lastName: formData.lastName,
                        email: formData.email,
                        phoneNumber: formData.phoneNumber,
                        center: formData.center,
                        type: formData.classType,
                        time: formData.preferredTime
                    };
                    
                    const momenceResponse = await fetch(webhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(dataForMomence)
                    });
                    
                    if (!momenceResponse.ok) {
                        throw new Error('Failed to submit to Momence: ' + momenceResponse.statusText);
                    }
                    
                    console.log('Successfully submitted new member lead to Momence');
                }
                
                // Add tag to member account (for existing members)
                if (memberId) {
                    await addMemberTag(memberId);
                } else {
                    console.log('Unable to add tag - member ID not available for new members');
                }
                
                // Send data to Google Sheet
                fetch(GOOGLE_SHEET_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...formData,
                        memberType: isExistingMember ? 'existing' : 'new',
                        membershipValid: isExistingMember && currentMembershipData ? 'yes' : 'no',
                        memberId: memberId || 'N/A'
                    })
                }).catch(err => console.error('Error sending to Google Sheet:', err));

                // Fire tracking pixels
                if (typeof fbq !== 'undefined') {
                    fbq('track', 'Lead');
                }
                
                if (typeof snaptr !== 'undefined') {
                    snaptr('track', 'SIGN_UP', {
                        'sign_up_method': 'Form Submission',
                        'user_email': formData.email,
                        'firstname': formData.firstName,
                        'lastname': formData.lastName,
                        'user_phone_number': formData.phoneNumber
                    });
                }

                console.log('Registration submitted successfully');
                return true;
            } catch (error) {
                console.error('Registration submission error:', error);
                return false;
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Get Google Sheets access token
            getGoogleAccessToken();
            
            // Authenticate with Momence on page load
            authenticate();
            
            // Show member search screen first and trigger auto-search
            const urlParams = new URLSearchParams(window.location.search);
            const emailParam = urlParams.get('email');
            
            if (emailParam) {
                // If email is in URL, auto-populate and search
                showScreen('member-search-screen');
                document.getElementById('searchInput').value = emailParam;
                setTimeout(() => {
                    searchMember();
                }, 500);
            }
            
            // Main form submission
            document.getElementById('main-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';
                
                try {
                    // Update form data with latest values
                    formData.firstName = document.getElementById('firstName').value;
                    formData.lastName = document.getElementById('lastName').value;
                    formData.email = document.getElementById('email').value;
                    formData.phoneNumber = document.getElementById('phoneNumber').value;
                    formData.center = document.getElementById('center').value;
                    formData.classType = 'Barre 57';
                    formData.preferredTime = 'Any';
                    
                    // Submit registration
                    const success = await submitRegistration();
                    
                    if (success) {
                        // Log to sheets
                        formData.notes = 'Registration completed successfully';
                        await logToGoogleSheets(formData, true);
                        hasLoggedToSheets = true;
                        
                        // Redirect to success page
                        window.top.location.href = 'https://momence.com/u/physique-57-india-fffoSp';
                    } else {
                        throw new Error('Registration submission failed');
                    }
                } catch (error) {
                    console.error('Form submission error:', error);
                    alert('An error occurred. Please try again.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Continue to Next Step';
                }
            });
            
            // Member status buttons
            document.getElementById('existing-member-btn').addEventListener('click', function() {
                isExistingMember = true;
                showScreen('member-search-screen');
            });
            
            document.getElementById('new-member-btn').addEventListener('click', function() {
                isExistingMember = false;
                
                // Log to sheets when user selects new member
                formData.memberType = 'New Member';
                formData.membershipStatus = 'None';
                formData.notes = 'User selected new member option';
                logToGoogleSheets(formData, true);
                hasLoggedToSheets = true;
                
                submitRegistration();
                showScreen('new-member-screen');
            });
            
            // Back buttons
            document.getElementById('back-to-form-btn').addEventListener('click', function() {
                showScreen('main-form');
            });
            
            document.getElementById('back-to-member-status-btn').addEventListener('click', function() {
                showScreen('member-status-screen');
            });
            
            document.getElementById('back-to-form-from-search-btn').addEventListener('click', function() {
                showScreen('main-form');
            });
            
            document.getElementById('back-to-form-from-new-btn').addEventListener('click', function() {
                showScreen('main-form');
            });
            
            document.getElementById('back-to-member-status-btn2').addEventListener('click', function() {
                showScreen('member-status-screen');
            });
            
            // Member search
            document.getElementById('search-member-btn').addEventListener('click', searchMember);
            
            // Action buttons
            document.getElementById('purchase-membership-btn').addEventListener('click', function() {
                // Log to sheets when user clicks purchase membership
                if (!hasLoggedToSheets && formData.email) {
                    formData.memberType = formData.memberType || 'New Member';
                    formData.membershipStatus = 'Purchase Clicked';
                    formData.notes = 'User clicked purchase membership';
                    logToGoogleSheets(formData, true);
                    hasLoggedToSheets = true;
                }
                window.open(PURCHASE_PAGE_URL, '_blank');
            });
            
            document.getElementById('whatsapp-contact-btn').addEventListener('click', function() {
                // Log to sheets when user clicks WhatsApp contact
                if (!hasLoggedToSheets && formData.email) {
                    formData.memberType = formData.memberType || 'New Member';
                    formData.membershipStatus = 'WhatsApp Contact';
                    formData.notes = 'User clicked WhatsApp contact';
                    logToGoogleSheets(formData, true);
                    hasLoggedToSheets = true;
                }
                openWhatsApp();
            });
            
            // Close message screen
            document.getElementById('close-message-btn').addEventListener('click', function() {
                window.location.reload();
            });

            // Detect form abandonment - log to sheets when user tries to leave
            window.addEventListener('beforeunload', function(e) {
                if (!hasLoggedToSheets && formData.email) {
                    // Log incomplete form data when user tries to leave
                    formData.memberType = formData.memberType || 'Unknown';
                    formData.membershipStatus = formData.membershipStatus || 'Form Abandoned';
                    formData.notes = 'User left form without completing';
                    
                    // Use sendBeacon for better reliability on page unload
                    if (navigator.sendBeacon) {
                        // Create a FormData object with the sheets data
                        const beaconData = new FormData();
                        beaconData.append('action', 'log_to_sheets');
                        beaconData.append('data', JSON.stringify(formData));
                        
                        // Try to send via beacon (works better on unload)
                        navigator.sendBeacon('/log-sheets', beaconData);
                    } else {
                        // Fallback - synchronous request (may not complete)
                        logToGoogleSheets(formData, false);
                    }
                    hasLoggedToSheets = true;
                }
            });

            // Also log when page visibility changes (user switches tabs, minimizes window)
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden' && !hasLoggedToSheets && formData.email) {
                    formData.memberType = formData.memberType || 'Unknown';
                    formData.membershipStatus = formData.membershipStatus || 'Form Incomplete';
                    formData.notes = 'User left form (tab hidden/switched)';
                    logToGoogleSheets(formData, false);
                    hasLoggedToSheets = true;
                }
            });

            // Fire Snap Pixel VIEW_CONTENT event
            if (typeof snaptr !== 'undefined') {
                snaptr('track', 'VIEW_CONTENT', {
                    'item_category': 'Fitness Membership'
                });
            }
        });
    </script>
</body>
</html>