<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7389670XJC"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-7389670XJC');
    </script>

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtag/js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-WHBZMFXL');</script>
    <!-- End Google Tag Manager -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physique 57 - New Member Registration</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --p57-primary: #6366f1;
            --p57-primary-dark: #4f46e5;
            --p57-secondary: #8b5cf6;
            --p57-white: #FFFFFF;
            --p57-gray-50: #f9fafb;
            --p57-gray-100: #f3f4f6;
            --p57-gray-200: #e5e7eb;
            --p57-gray-300: #d1d5db;
            --p57-gray-400: #9ca3af;
            --p57-gray-500: #6b7280;
            --p57-gray-600: #4b5563;
            --p57-gray-700: #374151;
            --p57-gray-800: #1f2937;
            --p57-gray-900: #111827;
            --p57-success: #10b981;
            --p57-error: #ef4444;
            --p57-warning: #f59e0b;
            --background-gradient: linear-gradient(135deg, #ffffff 0%, #f8fafc 30%, #f1f5f9 60%, #e2e8f0 100%);
            --card-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --border-radius: 24px;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--background-gradient);
            min-height: 100vh;
            color: var(--p57-gray-800);
            background-attachment: fixed;
            overflow-y: auto;
            position: relative;
        }
        
        /* Subtle Background Graphics */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(99, 102, 241, 0.02) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
            animation: float 20s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -30px) rotate(5deg); }
            66% { transform: translate(-20px, 20px) rotate(-5deg); }
        }
        
        .form-overlay {
            position: relative;
            top: auto;
            left: auto;
            transform: none;
            background-color: transparent;
            z-index: 1000;
            width: 100%;
            max-width: 520px;
            margin: 10px auto;
            padding: 10px;
            box-sizing: border-box;
            animation: fadeInScale 0.6s ease-out;
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .form-container {
            background: rgba(255, 255, 255, 0.98);
            padding: 24px 32px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            min-height: auto;
            position: relative;
            backdrop-filter: blur(20px);
        }
        
        .form-container:hover {
            transform: translateY(-4px);
            box-shadow: 0 32px 64px -12px rgba(0, 0, 0, 0.35);
        }
        
        .logo-container {
            text-align: center;
            margin-bottom: 16px;
            position: relative;
        }
        
        .logo-container img {
            max-width: 60px;
            height: auto;
            filter: none;
            transition: all 0.3s ease;
        }
        
        .brand-title {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--p57-primary), var(--p57-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 4px;
            letter-spacing: -1px;
            text-transform: uppercase;
        }
        
        .brand-subtitle {
            font-size: 13px;
            font-weight: 400;
            color: var(--p57-gray-600);
            text-align: center;
            margin-bottom: 16px;
            letter-spacing: 0.5px;
        }
        
        .screen-title {
            text-align: center;
            font-size: 20px;
            font-weight: 600;
            color: var(--p57-gray-900);
            margin-bottom: 8px;
            line-height: 1.2;
        }
        
        .screen-subtitle {
            text-align: center;
            font-size: 13px;
            color: var(--p57-gray-600);
            margin-bottom: 16px;
            line-height: 1.5;
            font-weight: 400;
        }
        
        #main-form {
            padding: 0;
        }
        
        #main-form label, #main-form p {
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 13px;
            color: var(--p57-gray-700);
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0;
        }
        
        #main-form input[type="text"], 
        #main-form input[type="email"], 
        #main-form input[type="tel"], 
        #main-form select,
        .search-input {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 14px;
            border: 2px solid var(--p57-gray-200);
            border-radius: 16px;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            font-weight: 400;
            transition: all 0.3s ease;
            background: var(--p57-gray-50);
            color: var(--p57-gray-900);
        }
        
        #main-form input[type="text"]:focus, 
        #main-form input[type="email"]:focus, 
        #main-form input[type="tel"]:focus, 
        #main-form select:focus,
        .search-input:focus {
            outline: none;
            border-color: var(--p57-primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            background: var(--p57-white);
            transform: translateY(-1px);
        }
        
        button {
            padding: 14px 24px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            border: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: none;
            letter-spacing: 0;
        }
        
        button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        button:hover:before {
            left: 100%;
        }
        
        button.submit {
            background: linear-gradient(135deg, var(--p57-primary), var(--p57-primary-dark));
            color: var(--p57-white);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
            font-weight: 600;
            border-radius: 16px;
        }
        
        button.submit:hover {
            background: linear-gradient(135deg, var(--p57-primary-dark), var(--p57-secondary));
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.4);
        }
        
        button.submit:active {
            transform: translateY(0);
        }
        
        button.secondary {
            background: var(--p57-white);
            color: var(--p57-gray-700);
            border: 2px solid var(--p57-gray-200);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-radius: 16px;
        }
        
        button.secondary:hover {
            background: var(--p57-gray-50);
            border-color: var(--p57-primary);
            color: var(--p57-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.15);
        }
        
        button.purchase {
            background: linear-gradient(135deg, var(--p57-success), #059669);
            color: white;
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
            border-radius: 16px;
        }
        
        button.purchase:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(16, 185, 129, 0.4);
        }
        
        button.whatsapp {
            background: linear-gradient(135deg, #25d366, #128c7e);
            color: white;
            box-shadow: 0 10px 25px rgba(37, 211, 102, 0.3);
            border-radius: 16px;
        }
        
        button.whatsapp:hover {
            background: linear-gradient(135deg, #128c7e, #0d7377);
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(37, 211, 102, 0.4);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .required {
            color: var(--p57-error);
            font-weight: 700;
        }
        
        .success-message {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            color: var(--p57-success);
            padding: 16px 20px;
            border-radius: 16px;
            margin-bottom: 16px;
            font-size: 14px;
            border: 2px solid rgba(16, 185, 129, 0.2);
            text-align: center;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
        }
        
        .error-message {
            background: linear-gradient(135deg, #fef2f2, #fecaca);
            color: var(--p57-error);
            padding: 16px 20px;
            border-radius: 16px;
            margin-bottom: 16px;
            font-size: 14px;
            border: 2px solid rgba(239, 68, 68, 0.2);
            text-align: center;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.1);
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Progress indicator */
        .progress-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 16px;
        }
        
        .progress-step {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--p57-gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--p57-gray-500);
            font-weight: 600;
            font-size: 12px;
            margin: 0 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .progress-step.active {
            background: var(--p57-primary);
            color: var(--p57-white);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
            transform: scale(1.1);
        }
        
        .progress-step.completed {
            background: var(--p57-success);
            color: var(--p57-white);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }
        
        @media (max-width: 600px) {
            body {
                padding: 16px;
            }
            
            .form-overlay {
                margin: 20px auto;
                padding: 0;
            }
            
            .form-container {
                padding: 32px 24px;
                border-radius: 20px;
            }
            
            .brand-title {
                font-size: 28px;
            }
            
            .screen-title {
                font-size: 22px;
            }
            
            .progress-step {
                width: 32px;
                height: 32px;
                font-size: 12px;
                margin: 0 8px;
            }
            
            button {
                padding: 16px 24px;
                font-size: 14px;
            }
        }
        
        /* Membership Selection Styles */
        .membership-card {
            background: linear-gradient(135deg, var(--p57-gray-50), var(--p57-white));
            border: 2px solid var(--p57-gray-200);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .membership-card:hover {
            border-color: var(--p57-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.15);
        }
        
        .membership-card.selected {
            border-color: var(--p57-primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.2);
        }
        
        .membership-card.selected::after {
            content: '✓';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 24px;
            height: 24px;
            background: var(--p57-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }
        
        .membership-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--p57-gray-900);
            margin-bottom: 4px;
        }
        
        .membership-type {
            font-size: 12px;
            color: var(--p57-gray-600);
            margin-bottom: 8px;
        }
        
        .membership-details {
            font-size: 11px;
            color: var(--p57-gray-500);
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .membership-detail-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .membership-status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
        }
        
        .membership-status-badge.active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--p57-success);
        }
        
        .membership-status-badge.inactive {
            background: rgba(239, 68, 68, 0.1);
            color: var(--p57-error);
        }
        
        .membership-status-badge.frozen {
            background: rgba(245, 158, 11, 0.1);
            color: var(--p57-warning);
        }
        
        #membership-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 16px 0;
        }
        
        #membership-list::-webkit-scrollbar {
            width: 6px;
        }
        
        #membership-list::-webkit-scrollbar-track {
            background: var(--p57-gray-100);
            border-radius: 10px;
        }
        
        #membership-list::-webkit-scrollbar-thumb {
            background: var(--p57-gray-300);
            border-radius: 10px;
        }
        
        #membership-list::-webkit-scrollbar-thumb:hover {
            background: var(--p57-gray-400);
        }
    </style>

    <!-- Snap Pixel Code -->
    <script type='text/javascript'>
        (function(e, t, n) {
            if (e.snaptr) return;
            var a = e.snaptr = function() {
                a.handleRequest ? a.handleRequest.apply(a, arguments) : a.queue.push(arguments)
            };
            a.queue = [];
            var s = 'script';
            r = t.createElement(s);
            r.async = !0;
            r.src = n;
            var u = t.getElementsByTagName(s)[0];
            u.parentNode.insertBefore(r, u);
        })(window, document, 'https://sc-static.net/scevent.min.js');

        snaptr('init', '5217a3a7-5f50-4c98-803c-a73c9f05737e', {
            'user_email': '__INSERT_USER_EMAIL__'
        });

        snaptr('track', 'PAGE_VIEW');
    </script>
    <!-- End Snap Pixel Code -->

    <!-- Meta Pixel script -->
    <script>
        !function(f, b, e, v, n, t, s) {
            if (f.fbq) return;
            n = f.fbq = function() {
                n.callMethod ? n.callMethod.apply(n, arguments) : n.queue.push(arguments)
            };
            if (!f._fbq) f._fbq = n;
            n.push = n;
            n.loaded = !0;
            n.version = '2.0';
            n.queue = [];
            t = b.createElement(e);
            t.async = !0;
            t.src = v;
            s = b.getElementsByTagName(e)[0];
            s.parentNode.insertBefore(t, s)
        }(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '527819981439695');
        fbq('track', 'PageView');
    </script>
        <img src="https://www.facebook.com/tr?id=527819981439695&ev=PageView&noscript=1" alt="Facebook tracking pixel for analytics purposes" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-809104648"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'AW-809104648');
    </script>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WHBZMFXL"
            height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="form-overlay" id="form-overlay">
        <div class="form-container">
            <!-- Main Registration Form (First Screen) -->
            <form id="main-form">
                <div class="logo-container">
                    <img src="logo.jpeg" alt="Physique 57">
                </div>
                
                <h1 class="brand-title">PHYSIQUE 57</h1>
                <p class="brand-subtitle">Transform Your Body, Transform Your Life</p>
                
                <div class="progress-indicator">
                    <div class="progress-step active">1</div>
                    <div class="progress-step">2</div>
                    <div class="progress-step">3</div>
                </div>
                
                <h2 class="screen-title">Let's Get Started</h2>
                
                <div id="form-messages"></div>

                <label for="firstName">First Name <span class="required">*</span></label>
                <input type="text" id="firstName" name="firstName" required>

                <label for="lastName">Last Name <span class="required">*</span></label>
                <input type="text" id="lastName" name="lastName" required>

                <label for="email">Email Address <span class="required">*</span></label>
                <input type="email" id="email" name="email" required>
                
                <div id="otp-section" class="hidden" style="margin-bottom: 14px;">
                    <label for="otp-input">Verification Code <span class="required">*</span></label>
                    <div style="display: flex; gap: 10px; align-items: flex-start;">
                        <input type="text" id="otp-input" name="otp" placeholder="Enter 6-digit code" maxlength="6" pattern="[0-9]{6}" style="flex: 1; margin-bottom: 0;">
                        <button type="button" id="verify-otp-btn" class="secondary" style="padding: 12px 20px; white-space: nowrap; margin-bottom: 0;">Verify</button>
                    </div>
                    <div id="otp-timer" style="font-size: 12px; color: var(--p57-gray-600); margin-top: 8px;"></div>
                    <button type="button" id="resend-otp-btn" class="hidden" style="font-size: 12px; background: transparent; color: var(--p57-primary); padding: 4px 0; box-shadow: none; text-decoration: underline;">Resend Code</button>
                </div>
                
                <div id="email-verified-message" class="hidden success-message" style="margin-bottom: 14px; font-size: 12px; padding: 10px 16px;">
                    ✓ Email verified successfully
                </div>

                <label for="phoneNumber">Phone Number <span class="required">*</span></label>
                <input type="tel" id="phoneNumber" name="phoneNumber" required placeholder="+91XXXXXXXXXX" oninput="formatPhoneNumber()">

                <label for="center">Select Studio Location <span class="required">*</span></label>
                <select id="center" name="center" required>
                    <option value="" disabled selected>Choose Your Preferred Studio</option>
                    <option value="Supreme Headquarters, Bandra">Supreme Headquarters, Bandra</option>
                    <option value="Kwality House, Kemps Corner">Kwality House, Kemps Corner</option>
                    <option value="Kenkere House, Bengaluru">Kenkere House, Bengaluru</option>
                </select>

                <!-- Hidden fields -->
                <input type="hidden" id="classType" name="classType" value="Barre 57">
                <input type="hidden" id="preferredTime" name="preferredTime" value="Any">

                <button type="submit" class="submit" style="width: 100%;">Continue to Next Step</button>
            </form>

            <!-- Member Status Check (Second Screen) -->
            <div id="member-status-screen" class="hidden">
                <div class="logo-container">
                    <img src="logo.jpeg" alt="Physique 57">
                </div>
                
                <h1 class="brand-title">PHYSIQUE 57</h1>
                
                <div class="progress-indicator">
                    <div class="progress-step completed">✓</div>
                    <div class="progress-step active">2</div>
                    <div class="progress-step">3</div>
                </div>
                
                <h2 class="screen-title">Membership Status</h2>
                <p class="screen-subtitle">Do you have an active membership with Physique 57?</p>

                <div style="display: flex; gap: 15px; margin-bottom: 30px;">
                    <button type="button" id="existing-member-btn" class="submit" style="flex: 1;">
                        Yes, I'm a Member
                    </button>
                    <button type="button" id="new-member-btn" class="secondary" style="flex: 1;">
                        No, I'm New
                    </button>
                </div>
                
                <button type="button" id="back-to-form-btn" class="secondary" style="width: 100%;">Back</button>
            </div>

            <!-- Existing Member Search (Third Screen Option A) -->
            <div id="member-search-screen" class="hidden">
                <div class="logo-container">
                    <img src="logo.jpeg" alt="Physique 57">
                </div>
                
                <h1 class="brand-title">PHYSIQUE 57</h1>
                
                <div class="progress-indicator">
                    <div class="progress-step completed">✓</div>
                    <div class="progress-step completed">✓</div>
                    <div class="progress-step active">3</div>
                </div>
                
                <h2 class="screen-title">Find Your Membership</h2>
                <p class="screen-subtitle">Enter your registered email or phone number</p>
                
                <label for="searchInput">Email or Phone Number <span class="required">*</span></label>
                <input type="text" id="searchInput" name="searchInput" class="search-input" placeholder="Enter email or phone number" required>
                
                <button type="button" id="search-member-btn" class="submit" style="width: 100%; margin-bottom: 15px;">
                    Search Membership
                </button>
                
                <button type="button" id="back-to-form-from-search-btn" class="secondary" style="width: 100%;">
                    ← Back to Form
                </button>
            </div>

            <!-- Membership Selection Screen -->
            <div id="membership-selection-screen" class="hidden">
                <div class="logo-container">
                    <img src="logo.jpeg" alt="Physique 57">
                </div>
                
                <h1 class="brand-title">PHYSIQUE 57</h1>
                
                <div class="progress-indicator">
                    <div class="progress-step completed">✓</div>
                    <div class="progress-step completed">✓</div>
                    <div class="progress-step active">3</div>
                </div>
                
                <h2 class="screen-title" id="membership-screen-title">Select Your Membership</h2>
                <p class="screen-subtitle" id="membership-screen-subtitle">Choose a membership to continue</p>
                
                <div id="membership-list"></div>
                
                <button type="button" id="submit-final-btn" class="submit" style="width: 100%; margin-bottom: 12px;" disabled>
                    Submit Registration
                </button>
                
                <button type="button" id="back-from-membership-btn" class="secondary" style="width: 100%;">
                    ← Back
                </button>
            </div>

            <!-- New Member Options (Third Screen Option B) -->
            <div id="new-member-screen" class="hidden">
                <div class="logo-container">
                    <img src="logo.jpeg" alt="Physique 57">
                </div>
                
                <h1 class="brand-title">PHYSIQUE 57</h1>
                
                <div class="progress-indicator">
                    <div class="progress-step completed">✓</div>
                    <div class="progress-step completed">✓</div>
                    <div class="progress-step active">3</div>
                </div>
                
                <h2 class="screen-title">Welcome to Physique 57!</h2>
                <p class="screen-subtitle">Ready to transform your body and mind? Let's get you started with a membership.</p>
                
                <div class="success-message">
                    Your registration has been submitted! Our team will reach out to you shortly to complete the process.
                </div>

                <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px;">
                    <button type="button" id="purchase-membership-btn" class="purchase" style="width: 100%;">
                        Purchase Membership Online
                    </button>
                    
                    <button type="button" id="whatsapp-contact-btn" class="whatsapp" style="width: 100%;">
                        Chat with Our Team
                    </button>
                </div>
                
                <button type="button" id="back-to-form-from-new-btn" class="secondary" style="width: 100%;">
                    ← Back to Form
                </button>
            </div>

            <!-- Success/Error Messages Screen -->
            <div id="message-screen" class="hidden">
                <div class="logo-container">
                    <img src="logo.jpeg" alt="Physique 57">
                </div>
                
                <h1 class="brand-title">PHYSIQUE 57</h1>
                
                <div id="message-content"></div>
                
                <button type="button" id="close-message-btn" class="secondary" style="width: 100%;">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Google OAuth credentials for Sheets integration
        const GOOGLE_CLIENT_ID = '581427527932-f6d4m2ollrro6ttnid0g69t7crppbdt7.apps.googleusercontent.com';
        const GOOGLE_CLIENT_SECRET = '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';
        const GOOGLE_REFRESH_TOKEN = '1//04fQo2Xgv3I26CgYIARAAGAQSNwF-L9IrlezyhDGLxIDmQkDNZgOo2WmH54p5rwqHA6D2VTjLvLAefriciqMVG99okFBle4QYMLo';
        const SPREADSHEET_ID = '1zUTUmjTkBKf7JNkQEnr13mtyIPRq4nRSqSvk2wRMgM0';
        const SIGNUPS_SHEET_NAME = 'Signups';
        const INCOMPLETE_SHEET_NAME = 'Incomplete';
        
        // Momence API Configuration
        const MOMENCE_BASE_URL = 'https://api.momence.com/api/v2';
        const MOMENCE_BASIC_AUTH = 'Basic YXBpLTEzNzUyLUtYRTBPRFVQR3BTdkVrR1E6dlpPWkRGSHk0dEtOeWYzOHpvZ0JtQnRZSElSaTJldVo=';
        const MOMENCE_USERNAME = 'physique57mumbai1@gmail.com';
        const MOMENCE_PASSWORD = 'Jimmeey@123';
        const TAG_ID = '67caa94ca4a48f3e5e82f5d8'; // Tag ID for member tagging
        const PURCHASE_PAGE_URL = 'https://momence.com/m/69064';
        const WHATSAPP_NUMBER = '+918779292745';
        
        let googleAccessToken = null;
        let momenceAccessToken = null;
        let momenceRefreshToken = null;
        let isExistingMember = false;
        let currentMembershipData = null;
        let selectedMembership = null;
        let foundMemberships = [];
        let formData = {};
        let hasLoggedToSheets = false;
        let emailVerified = false;
        let generatedOTP = null;
        let otpSentEmail = null;
        
        // Send OTP via Vercel serverless function
        async function sendOTPEmail(email, otp) {
            try {
                console.log('Sending OTP to:', email);
                
                // Call Vercel serverless function
                const response = await fetch('/api/send-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        otp: otp
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    console.error('Failed to send OTP:', result.error || 'Unknown error');
                    return { success: false, error: result.error || 'Failed to send verification code' };
                }
                
                console.log('OTP sent successfully to:', email);
                return { success: true };
                
            } catch (error) {
                console.error('Error sending OTP email:', error);
                return { success: false, error: error.message };
            }
        }
        
        // Generate random 6-digit OTP
        function generateOTP() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }
        
        // Get Google Sheets access token
        async function getGoogleAccessToken() {
            try {
                const response = await fetch('https://oauth2.googleapis.com/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        client_id: GOOGLE_CLIENT_ID,
                        client_secret: GOOGLE_CLIENT_SECRET,
                        refresh_token: GOOGLE_REFRESH_TOKEN,
                        grant_type: 'refresh_token'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                googleAccessToken = data.access_token;
                return googleAccessToken;
            } catch (error) {
                console.error('Error getting access token:', error);
                return null;
            }
        }
        
        // Authenticate with Momence API using correct method
        async function authenticate() {
            try {
                const authResponse = await fetch(
                    "https://api.momence.com/api/v2/auth/token",
                    {
                        method: "POST",
                        headers: {
                            accept: "application/json",
                            authorization: MOMENCE_BASIC_AUTH,
                            "content-type": "application/x-www-form-urlencoded",
                        },
                        body: new URLSearchParams({
                            grant_type: "password",
                            username: MOMENCE_USERNAME,
                            password: MOMENCE_PASSWORD,
                        }),
                    }
                );

                if (!authResponse.ok) {
                    throw new Error(`Authentication failed: ${authResponse.status}`);
                }

                const authData = await authResponse.json();
                momenceAccessToken = authData.access_token;
                momenceRefreshToken = authData.refreshToken;

                console.log('Momence authentication successful');
                return { success: true };
            } catch (error) {
                console.error("Error during authentication:", error);
                return { success: false, error: error.message };
            }
        }

        // Refresh Momence access token
        async function refreshAccessToken() {
            try {
                const refreshResponse = await fetch(
                    "https://api.momence.com/api/v2/auth/token",
                    {
                        method: "POST",
                        headers: {
                            accept: "application/json",
                            authorization: MOMENCE_BASIC_AUTH,
                            "content-type": "application/x-www-form-urlencoded",
                        },
                        body: new URLSearchParams({
                            grant_type: "refresh_token",
                            refresh_token: momenceRefreshToken,
                        }),
                    }
                );

                if (!refreshResponse.ok) {
                    throw new Error(`Token refresh failed: ${refreshResponse.status}`);
                }

                const refreshData = await refreshResponse.json();
                momenceAccessToken = refreshData.access_token;
                momenceRefreshToken = refreshData.refreshToken;

                console.log('Momence token refreshed successfully');
            } catch (error) {
                console.error("Error refreshing access token:", error);
                // If refresh fails, try to authenticate again
                await authenticate();
            }
        }
        
        // Log to Signups sheet (complete submissions only, no duplicates)
        async function logToSignupsSheet(data) {
            try {
                if (!googleAccessToken) {
                    await getGoogleAccessToken();
                }
                
                if (!googleAccessToken) {
                    console.error('Failed to get access token');
                    return;
                }
                
                await ensureSheetHeaders(SIGNUPS_SHEET_NAME);
                
                const timestamp = new Date().toLocaleString('en-IN', {
                    timeZone: 'Asia/Kolkata',
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                // Check if email already exists in Signups sheet
                const existingRowIndex = await findRowByEmail(data.email, SIGNUPS_SHEET_NAME);
                
                const rowData = [
                    timestamp,
                    data.firstName || '',
                    data.lastName || '',
                    data.email || '',
                    data.phoneNumber || '',
                    data.center || '',
                    data.memberType || '',
                    data.membershipStatus || '',
                    data.notes || '',
                    data.membershipDetails || '',
                    data.membershipName || '',
                    data.membershipType || '',
                    data.membershipStartDate || '',
                    data.membershipEndDate || '',
                    data.membershipCreditsLeft || '',
                    data.membershipIsFrozen || ''
                ];
                
                if (existingRowIndex !== -1) {
                    // Update existing row
                    const range = `${SIGNUPS_SHEET_NAME}!A${existingRowIndex + 1}:P${existingRowIndex + 1}`;
                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?valueInputOption=RAW`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${googleAccessToken}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ values: [rowData] })
                        }
                    );
                    
                    if (!response.ok) {
                        throw new Error(`Signups sheet update error: ${response.status}`);
                    }
                    
                    console.log('Successfully updated existing row in Signups sheet:', data);
                } else {
                    // Create new row
                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SIGNUPS_SHEET_NAME}:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS`,
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${googleAccessToken}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ values: [rowData] })
                        }
                    );
                    
                    if (!response.ok) {
                        throw new Error(`Signups sheet append error: ${response.status}`);
                    }
                    
                    console.log('Successfully added new row to Signups sheet:', data);
                }
                
            } catch (error) {
                console.error('Error logging to Signups sheet:', error);
            }
        }
        
        // Log to Incomplete sheet (always append, allows duplicates)
        async function logToIncompleteSheet(data) {
            try {
                if (!googleAccessToken) {
                    await getGoogleAccessToken();
                }
                
                if (!googleAccessToken) {
                    console.error('Failed to get access token');
                    return;
                }
                
                await ensureSheetHeaders(INCOMPLETE_SHEET_NAME);
                
                const timestamp = new Date().toLocaleString('en-IN', {
                    timeZone: 'Asia/Kolkata',
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const rowData = [
                    timestamp,
                    data.firstName || '',
                    data.lastName || '',
                    data.email || '',
                    data.phoneNumber || '',
                    data.center || '',
                    data.memberType || '',
                    data.membershipStatus || '',
                    data.notes || '',
                    data.membershipDetails || '',
                    data.membershipName || '',
                    data.membershipType || '',
                    data.membershipStartDate || '',
                    data.membershipEndDate || '',
                    data.membershipCreditsLeft || '',
                    data.membershipIsFrozen || ''
                ];
                
                // Always append to Incomplete sheet (duplicates allowed)
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${INCOMPLETE_SHEET_NAME}:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ values: [rowData] })
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Incomplete sheet append error: ${response.status}`);
                }
                
                console.log('Successfully added row to Incomplete sheet:', data);
                
            } catch (error) {
                console.error('Error logging to Incomplete sheet:', error);
            }
        }
        
        // Find row index by email in Google Sheets
        async function findRowByEmail(email, sheetName) {
            try {
                if (!email) return -1;
                
                // Get all data from the sheet
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${sheetName}!A:P`,
                    {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`,
                            'Content-Type': 'application/json',
                        }
                    }
                );
                
                if (!response.ok) {
                    console.error('Failed to fetch sheet data:', response.status);
                    return -1;
                }
                
                const data = await response.json();
                if (!data.values || data.values.length <= 1) {
                    return -1; // No data rows (only headers or empty)
                }
                
                // Find row with matching email (column D, index 3)
                for (let i = 1; i < data.values.length; i++) {
                    const row = data.values[i];
                    if (row[3] && row[3].toLowerCase() === email.toLowerCase()) {
                        return i; // Return 0-based index
                    }
                }
                
                return -1; // Not found
            } catch (error) {
                console.error('Error finding row by email:', error);
                return -1;
            }
        }
        
        // Ensure Google Sheet has proper headers
        async function ensureSheetHeaders(sheetName) {
            try {
                // Check if sheet has data
                const checkResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${sheetName}!A1:P1`,
                    {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`,
                            'Content-Type': 'application/json',
                        }
                    }
                );
                
                if (!checkResponse.ok) {
                    throw new Error(`Failed to check sheet headers: ${checkResponse.status}`);
                }
                
                const checkData = await checkResponse.json();
                
                // If sheet is empty or doesn't have proper headers, add them
                if (!checkData.values || checkData.values.length === 0 || 
                    !checkData.values[0] || checkData.values[0][0] !== 'Timestamp') {
                    
                    const headers = [
                        'Timestamp',
                        'First Name', 
                        'Last Name',
                        'Email',
                        'Phone Number',
                        'Center',
                        'Member Type',
                        'Membership Status',
                        'Notes',
                        'Membership Details',
                        'Membership Name',
                        'Membership Type',
                        'Membership Start Date',
                        'Membership End Date',
                        'Credits Left',
                        'Is Frozen'
                    ];
                    
                    const headerRequestBody = {
                        values: [headers]
                    };
                    
                    // Clear the sheet first if it has wrong headers
                    if (checkData.values && checkData.values.length > 0) {
                        await fetch(
                            `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${sheetName}:clear`,
                            {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${googleAccessToken}`,
                                    'Content-Type': 'application/json',
                                }
                            }
                        );
                    }
                    
                    // Add headers
                    const headerResponse = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${sheetName}!A1:append?valueInputOption=RAW`,
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${googleAccessToken}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(headerRequestBody)
                        }
                    );
                    
                    if (!headerResponse.ok) {
                        throw new Error(`Failed to add headers: ${headerResponse.status}`);
                    }
                    
                    console.log('Headers added to Google Sheet');
                }
            } catch (error) {
                console.error('Error ensuring sheet headers:', error);
            }
        }
        
        // Show/Hide screens
        function showScreen(screenId) {
            const screens = ['main-form', 'member-status-screen', 'member-search-screen', 'membership-selection-screen', 'new-member-screen', 'message-screen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }
        
        // Add member tag function
        async function addMemberTag(memberId) {
            try {
                if (!momenceAccessToken && !(await authenticate())) {
                    throw new Error('Failed to authenticate');
                }
                
                const url = `${MOMENCE_BASE_URL}/host/members/${memberId}/tags/${TAG_ID}`;
                
                let response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'accept': 'application/json',
                        'authorization': `Bearer ${momenceAccessToken}`
                    }
                });
                
                if (response.status === 401) {
                    await refreshAccessToken();
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'accept': 'application/json',
                            'authorization': `Bearer ${momenceAccessToken}`
                        }
                    });
                }
                
                if (response.ok) {
                    console.log('Successfully added tag to member:', memberId);
                    return true;
                } else {
                    console.error('Failed to add tag to member:', memberId, response.status);
                    return false;
                }
            } catch (error) {
                console.error('Error adding member tag:', error);
                return false;
            }
        }
        
        // Show message screen
        function showMessage(type, title, message, hasActions = false) {
            const messageContent = document.getElementById('message-content');
            let messageClass = type === 'success' ? 'success-message' : 'error-message';
            
            messageContent.innerHTML = `
                <div class="progress-indicator">
                    <div class="progress-step completed">✓</div>
                    <div class="progress-step completed">✓</div>
                    <div class="progress-step ${type === 'success' ? 'completed' : 'active'}">${type === 'success' ? '✓' : '3'}</div>
                </div>
                <h2 class="screen-title">${title}</h2>
                <div class="${messageClass}">${message}</div>
                ${hasActions ? `
                    <div style="display: flex; flex-direction: column; gap: 15px; margin: 30px 0;">
                        <button type="button" id="purchase-membership-btn2" class="purchase" style="width: 100%;">
                            Purchase Membership Online
                        </button>
                        <button type="button" id="whatsapp-contact-btn2" class="whatsapp" style="width: 100%;">
                            Chat with Our Team
                        </button>
                    </div>
                ` : ''}
            `;
            
            showScreen('message-screen');
            
            if (hasActions) {
                document.getElementById('purchase-membership-btn2').onclick = () => window.open(PURCHASE_PAGE_URL, '_blank');
                document.getElementById('whatsapp-contact-btn2').onclick = openWhatsApp;
            }
        }
        
        // Open WhatsApp
        function openWhatsApp() {
            const message = `Hi! I'm interested in Physique 57 membership. My details:\n\nName: ${formData.firstName || ''} ${formData.lastName || ''}\nEmail: ${formData.email || ''}\nPhone: ${formData.phoneNumber || ''}\nPreferred Studio: ${formData.center || ''}\n\nCould you please help me with membership options?`;
            const whatsappURL = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
            window.open(whatsappURL, '_blank');
        }
        
        // Format phone number
        function formatPhoneNumber() {
            let input = document.getElementById('phoneNumber');
            let number = input.value.replace(/\D/g, '');
            const countryCodes = ['1', '33', '971', '44', '63', '65', '34'];

            function startsWithCode(num) {
                return countryCodes.some(code => num.startsWith(code));
            }

            if (number.length === 10 && !startsWithCode(number)) {
                input.value = '+91' + number;
            } else if (startsWithCode(number)) {
                input.value = '+' + number;
            } else {
                input.value = '+' + number;
            }
        }
        

        // Search for member using correct Momence API
        async function searchMember() {
            const searchInput = document.getElementById('searchInput').value.trim();
            const searchButton = document.getElementById('search-member-btn');
            
            if (!searchInput) {
                alert('Please enter email or phone number');
                return;
            }

            searchButton.disabled = true;
            searchButton.textContent = 'Searching...';
            foundMemberships = [];

            try {
                // Authenticate first if no token
                if (!momenceAccessToken) {
                    const authResult = await authenticate();
                    if (!authResult.success) {
                        throw new Error('Failed to authenticate with Momence API');
                    }
                }

                console.log('Searching for member with:', searchInput);
                
                // Step 1: Get member ID using email
                let memberResponse = await fetch(
                    `https://api.momence.com/api/v2/host/members?page=0&pageSize=100&sortOrder=DESC&sortBy=firstSeenAt&query=${encodeURIComponent(searchInput)}`,
                    {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Authorization': `Bearer ${momenceAccessToken}`
                        }
                    }
                );
                
                // Handle 401 by refreshing token
                if (memberResponse.status === 401) {
                    await refreshAccessToken();
                    memberResponse = await fetch(
                        `https://api.momence.com/api/v2/host/members?page=0&pageSize=100&sortOrder=DESC&sortBy=firstSeenAt&query=${encodeURIComponent(searchInput)}`,
                        {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Authorization': `Bearer ${momenceAccessToken}`
                            }
                        }
                    );
                }
                
                console.log('Member search response status:', memberResponse.status);
                
                if (!memberResponse.ok) {
                    const errorText = await memberResponse.text();
                    console.error('Member search API error:', errorText);
                    throw new Error(`Member search failed: ${memberResponse.status} - ${errorText}`);
                }
                
                const memberData = await memberResponse.json();
                console.log('Member search response:', memberData);
                
                let member = null;
                if (memberData.payload && memberData.payload.length > 0) {
                    // Find exact email match
                    member = memberData.payload.find(m => 
                        m.email && m.email.toLowerCase() === searchInput.toLowerCase()
                    );
                    if (!member) {
                        member = memberData.payload[0]; // Fallback to first result
                    }
                }
                
                if (!member) {
                    // User is not a member, show new member screen
                    formData.memberType = 'New Member';
                    formData.membershipStatus = 'None';
                    formData.notes = 'No existing membership found';
                    
                    showScreen('new-member-screen');
                    return;
                }

                console.log('Found member:', member);
                
                // Step 2: Get active memberships using member ID
                let membershipResponse = await fetch(
                    `https://api.momence.com/api/v2/host/members/${member.id}/bought-memberships/active?page=0&pageSize=200&includeFrozen=true`,
                    {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Authorization': `Bearer ${momenceAccessToken}`
                        }
                    }
                );
                
                // Handle 401 by refreshing token
                if (membershipResponse.status === 401) {
                    await refreshAccessToken();
                    membershipResponse = await fetch(
                        `https://api.momence.com/api/v2/host/members/${member.id}/bought-memberships/active?page=0&pageSize=200&includeFrozen=true`,
                        {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Authorization': `Bearer ${momenceAccessToken}`
                            }
                        }
                    );
                }
                
                console.log('Membership response status:', membershipResponse.status);
                
                if (membershipResponse.ok) {
                    const membershipData = await membershipResponse.json();
                    console.log('Membership response:', membershipData);
                    
                    if (membershipData.payload && membershipData.payload.length > 0) {
                        foundMemberships = membershipData.payload;
                    }
                }
                
                // Update form data with found member info
                formData.firstName = member.firstName || formData.firstName;
                formData.lastName = member.lastName || formData.lastName;
                formData.email = member.email || formData.email;
                formData.phoneNumber = member.phoneNumber || formData.phoneNumber;
                formData.memberType = 'Existing Member';
                
                currentMembershipData = member;
                
                // Show membership selection screen with results
                displayMembershipResults();

            } catch (error) {
                console.error('Member search error:', error);
                
                // Show error but allow to proceed as new member
                showMessage('error', 'Search Error', 
                    'Unable to verify your membership status. Please contact our team or proceed as a new member.',
                    true
                );
            } finally {
                searchButton.disabled = false;
                searchButton.textContent = 'Search Membership';
            }
        }
        
        // Display membership results in selection screen
        function displayMembershipResults() {
            const membershipList = document.getElementById('membership-list');
            const titleElement = document.getElementById('membership-screen-title');
            const subtitleElement = document.getElementById('membership-screen-subtitle');
            
            membershipList.innerHTML = '';
            
            if (foundMemberships.length === 0) {
                titleElement.textContent = 'No Active Memberships Found';
                subtitleElement.textContent = 'We could not find an active membership for your account';
                
                membershipList.innerHTML = `
                    <div class="error-message">
                        No active memberships found. Please purchase a membership to continue.
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;">
                        <button type="button" class="purchase" style="width: 100%;" onclick="window.open('${PURCHASE_PAGE_URL}', '_blank')">
                            Purchase Membership Online
                        </button>
                        <button type="button" class="whatsapp" style="width: 100%;" onclick="openWhatsApp()">
                            Chat with Our Team
                        </button>
                    </div>
                `;
                
                document.getElementById('submit-final-btn').style.display = 'none';
            } else {
                titleElement.textContent = 'Select Your Membership';
                subtitleElement.textContent = 'Choose the membership you want to use for this registration';
                
                foundMemberships.forEach((membership, index) => {
                    const creditsLeft = membership.eventCreditsLeft || 
                                       (membership.usageLimitForSessions - membership.usedSessions) || 
                                       'Unlimited';
                    const status = membership.isFrozen ? 'frozen' : 'active';
                    const statusText = membership.isFrozen ? 'Frozen' : 'Active';
                    
                    const card = document.createElement('div');
                    card.className = 'membership-card';
                    card.setAttribute('data-index', index);
                    card.innerHTML = `
                        <div class="membership-name">${membership.membership?.name || 'Membership'}</div>
                        <div class="membership-type">${membership.type || 'Standard'}</div>
                        <div class="membership-details">
                            <div class="membership-detail-item">
                                <span>📅</span>
                                <span>${new Date(membership.startDate).toLocaleDateString()} - ${new Date(membership.endDate).toLocaleDateString()}</span>
                            </div>
                            <div class="membership-detail-item">
                                <span>🎫</span>
                                <span>${creditsLeft} credits left</span>
                            </div>
                        </div>
                        <div class="membership-status-badge ${status}">${statusText}</div>
                    `;
                    
                    card.addEventListener('click', function() {
                        document.querySelectorAll('.membership-card').forEach(c => c.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedMembership = foundMemberships[index];
                        document.getElementById('submit-final-btn').disabled = false;
                    });
                    
                    membershipList.appendChild(card);
                });
                
                document.getElementById('submit-final-btn').style.display = 'block';
            }
            
            showScreen('membership-selection-screen');
        }


        // Submit registration to Momence webhooks (only for new members)
        async function submitRegistration() {
            try {
                // Only call webhooks for NEW members, not existing members
                if (!isExistingMember) {
                    // Determine Momence webhook URL based on center
                    let webhookUrl, webhookToken, sourceId;
                    
                    if (formData.center === 'Kenkere House, Bengaluru') {
                        webhookUrl = 'https://api.momence.com/integrations/customer-leads/33905/collect';
                        webhookToken = 'qy71rOk8en';
                        sourceId = '147133';
                    } else {
                        // Default Mumbai parameters for Supreme Headquarters and Kwality House
                        webhookUrl = 'https://api.momence.com/integrations/customer-leads/13752/collect';
                        webhookToken = 'DOjMVL37Q5';
                        sourceId = '147016';
                    }

                    const submissionData = {
                        token: webhookToken,
                        sourceId: sourceId,
                        firstName: formData.firstName,
                        lastName: formData.lastName,
                        email: formData.email,
                        phoneNumber: formData.phoneNumber,
                        center: formData.center,
                        type: formData.classType,
                        time: formData.preferredTime
                    };

                    // Send to Momence customer leads webhook
                    try {
                        const webhookResponse = await fetch(webhookUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${webhookToken}`
                            },
                            body: JSON.stringify(submissionData)
                        });
                        
                        if (webhookResponse.ok) {
                            console.log('Successfully submitted to Momence webhook for center:', formData.center);
                        } else {
                            console.error('Failed to submit to Momence webhook:', webhookResponse.status);
                        }
                    } catch (error) {
                        console.error('Error submitting to Momence webhook:', error);
                    }
                } else {
                    console.log('Existing member - skipping webhook call');
                    
                    // Add tag to existing member if they have a membership
                    if (currentMembershipData && currentMembershipData.id) {
                        console.log('Adding tag to existing member:', currentMembershipData.id);
                        await addMemberTag(currentMembershipData.id);
                    }
                }

                // Log complete registration to Signups sheet
                const logData = {
                    ...formData,
                    memberType: isExistingMember ? 'Existing Member' : 'New Member',
                    membershipStatus: isExistingMember && currentMembershipData ? 'Active' : 'None',
                    notes: 'Registration completed successfully'
                };
                
                await logToSignupsSheet(logData);
                hasLoggedToSheets = true;

                // Fire tracking pixels
                if (typeof fbq !== 'undefined') {
                    fbq('track', 'Lead');
                }
                
                if (typeof snaptr !== 'undefined') {
                    snaptr('track', 'SIGN_UP', {
                        'sign_up_method': 'Form Submission',
                        'user_email': formData.email,
                        'firstname': formData.firstName,
                        'lastname': formData.lastName,
                        'user_phone_number': formData.phoneNumber
                    });
                }

                console.log('Registration submitted successfully');
                return true;
            } catch (error) {
                console.error('Registration submission error:', error);
                return false;
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Get Google Sheets access token
            getGoogleAccessToken();
            
            // Track incomplete entries when user starts typing
            let incompleteDataLogged = false;
            const formInputs = ['firstName', 'lastName', 'email', 'phoneNumber', 'center'];
            
            formInputs.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', function() {
                        if (!incompleteDataLogged) {
                            const incompleteData = {
                                firstName: document.getElementById('firstName').value,
                                lastName: document.getElementById('lastName').value,
                                email: document.getElementById('email').value,
                                phoneNumber: document.getElementById('phoneNumber').value,
                                center: document.getElementById('center').value,
                                memberType: 'Unknown',
                                membershipStatus: 'Not checked',
                                notes: 'User started filling form but did not complete'
                            };
                            
                            // Only log if at least one field has data
                            if (Object.values(incompleteData).some(val => val && val.trim() && val !== 'Unknown' && val !== 'Not checked')) {
                                logToIncompleteSheet(incompleteData);
                                incompleteDataLogged = true;
                            }
                        }
                    });
                }
            });
            
            // Email verification handlers
            let otpTimer = null;
            let otpExpiryTime = null;
            
            document.getElementById('email').addEventListener('blur', async function() {
                const email = this.value.trim();
                if (email && !emailVerified && otpSentEmail !== email) {
                    // Send OTP automatically when user enters email
                    const otp = generateOTP();
                    generatedOTP = otp;
                    otpSentEmail = email;
                    
                    // Show OTP section immediately
                    document.getElementById('otp-section').classList.remove('hidden');
                    
                    const result = await sendOTPEmail(email, otp);
                    if (result.success) {
                        // Start 10-minute timer
                        otpExpiryTime = Date.now() + 10 * 60 * 1000;
                        startOTPTimer();
                        
                        // Show success feedback
                        const timerElement = document.getElementById('otp-timer');
                        timerElement.style.color = 'var(--p57-success)';
                        timerElement.textContent = '✓ Verification code sent to your email!';
                        setTimeout(() => {
                            if (otpExpiryTime) {
                                timerElement.style.color = 'var(--p57-gray-600)';
                            }
                        }, 3000);
                    } else {
                        document.getElementById('otp-section').classList.add('hidden');
                        alert('Failed to send verification code. Please check your email address and try again.');
                    }
                }
            });
            
            function startOTPTimer() {
                const timerElement = document.getElementById('otp-timer');
                const resendBtn = document.getElementById('resend-otp-btn');
                
                if (otpTimer) clearInterval(otpTimer);
                
                otpTimer = setInterval(() => {
                    const remaining = otpExpiryTime - Date.now();
                    if (remaining <= 0) {
                        clearInterval(otpTimer);
                        timerElement.textContent = 'Code expired';
                        resendBtn.classList.remove('hidden');
                    } else {
                        const minutes = Math.floor(remaining / 60000);
                        const seconds = Math.floor((remaining % 60000) / 1000);
                        timerElement.textContent = `Code expires in ${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            }
            
            document.getElementById('verify-otp-btn').addEventListener('click', function() {
                const enteredOTP = document.getElementById('otp-input').value.trim();
                const email = document.getElementById('email').value.trim();
                
                if (!enteredOTP) {
                    alert('Please enter the verification code');
                    return;
                }
                
                if (email !== otpSentEmail) {
                    alert('Email has been changed. Please wait for a new verification code.');
                    return;
                }
                
                if (Date.now() > otpExpiryTime) {
                    alert('Verification code has expired. Please request a new one.');
                    return;
                }
                
                if (enteredOTP === generatedOTP) {
                    emailVerified = true;
                    document.getElementById('otp-section').classList.add('hidden');
                    document.getElementById('email-verified-message').classList.remove('hidden');
                    document.getElementById('email').readOnly = true;
                    if (otpTimer) clearInterval(otpTimer);
                    console.log('Email verified successfully');
                } else {
                    alert('Invalid verification code. Please try again.');
                }
            });
            
            document.getElementById('resend-otp-btn').addEventListener('click', async function() {
                const email = document.getElementById('email').value.trim();
                if (!email) {
                    alert('Please enter your email address');
                    return;
                }
                
                this.disabled = true;
                this.textContent = 'Sending...';
                
                const otp = generateOTP();
                generatedOTP = otp;
                otpSentEmail = email;
                
                const result = await sendOTPEmail(email, otp);
                if (result.success) {
                    alert('A new verification code has been sent to your email');
                    otpExpiryTime = Date.now() + 10 * 60 * 1000;
                    startOTPTimer();
                    this.classList.add('hidden');
                    this.disabled = false;
                    this.textContent = 'Resend Code';
                } else {
                    alert('Failed to resend code. Please try again.');
                    this.disabled = false;
                    this.textContent = 'Resend Code';
                }
            });
            
            // Main form submission
            document.getElementById('main-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Check if email is verified
                if (!emailVerified) {
                    alert('Please verify your email address before continuing');
                    return;
                }
                
                // Store form data
                formData = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    phoneNumber: document.getElementById('phoneNumber').value,
                    center: document.getElementById('center').value,
                    classType: 'Barre 57',
                    preferredTime: 'Any'
                };
                
                // Go directly to member search and auto-search with email
                showScreen('member-search-screen');
                // Lock email field and pre-fill with verified email
                const searchInput = document.getElementById('searchInput');
                searchInput.value = formData.email;
                searchInput.readOnly = true;
                searchInput.style.backgroundColor = 'var(--p57-gray-100)';
                searchInput.style.cursor = 'not-allowed';
                
                // Auto-search after a short delay
                setTimeout(() => {
                    searchMember();
                }, 500);
            });
            
            // Member status buttons
            document.getElementById('existing-member-btn').addEventListener('click', function() {
                isExistingMember = true;
                showScreen('member-search-screen');
            });
            
            document.getElementById('new-member-btn').addEventListener('click', function() {
                isExistingMember = false;
                
                // Log to Incomplete sheet when user selects new member
                formData.memberType = 'New Member';
                formData.membershipStatus = 'None';
                formData.notes = 'User selected new member option - showing purchase options';
                logToIncompleteSheet(formData);
                
                showScreen('new-member-screen');
            });
            
            // Back buttons
            document.getElementById('back-to-form-btn').addEventListener('click', function() {
                showScreen('main-form');
            });
            
            document.getElementById('back-to-form-from-search-btn').addEventListener('click', function() {
                showScreen('main-form');
            });
            
            document.getElementById('back-to-form-from-new-btn').addEventListener('click', function() {
                showScreen('main-form');
            });
            
            document.getElementById('back-from-membership-btn').addEventListener('click', function() {
                showScreen('member-search-screen');
            });
            
            // Member search
            document.getElementById('search-member-btn').addEventListener('click', searchMember);
            
            // Final submission button
            document.getElementById('submit-final-btn').addEventListener('click', async function() {
                if (!selectedMembership) {
                    alert('Please select a membership to continue');
                    return;
                }
                
                this.disabled = true;
                this.textContent = 'Submitting...';
                
                // Add selected membership details to formData
                formData.membershipName = selectedMembership.membership?.name || 'Unknown';
                formData.membershipType = selectedMembership.type || 'Unknown';
                formData.membershipStartDate = selectedMembership.startDate || '';
                formData.membershipEndDate = selectedMembership.endDate || '';
                formData.membershipCreditsLeft = selectedMembership.eventCreditsLeft || 
                                                 (selectedMembership.usageLimitForSessions - selectedMembership.usedSessions) || 
                                                 'Unlimited';
                formData.membershipIsFrozen = selectedMembership.isFrozen ? 'Yes' : 'No';
                formData.membershipStatus = 'Active';
                formData.membershipDetails = `${formData.membershipName} - Credits Left: ${formData.membershipCreditsLeft}`;
                formData.notes = 'Registration submitted with selected membership';
                
                // Now submit the registration
                const success = await submitRegistration();
                
                if (success) {
                    showMessage('success', 'Registration Successful!', 
                        'Your registration has been submitted successfully! You will be redirected to complete your booking.'
                    );
                    
                    setTimeout(() => {
                        window.open('https://momence.com/u/physique-57-india-fffoSp', '_top');
                    }, 3000);
                } else {
                    showMessage('error', 'Submission Error', 
                        'There was an error submitting your registration. Please try again or contact our team.'
                    );
                    this.disabled = false;
                    this.textContent = 'Submit Registration';
                }
            });
            
            // Action buttons
            document.getElementById('purchase-membership-btn').addEventListener('click', function() {
                // Log to Signups sheet when user clicks purchase membership
                if (!hasLoggedToSheets && formData.email) {
                    formData.memberType = formData.memberType || 'New Member';
                    formData.membershipStatus = 'Purchase Clicked';
                    formData.notes = 'User clicked purchase membership';
                    logToSignupsSheet(formData);
                    hasLoggedToSheets = true;
                }
                window.open(PURCHASE_PAGE_URL, '_blank');
            });
            
            document.getElementById('whatsapp-contact-btn').addEventListener('click', function() {
                // Log to Signups sheet when user clicks WhatsApp contact
                if (!hasLoggedToSheets && formData.email) {
                    formData.memberType = formData.memberType || 'New Member';
                    formData.membershipStatus = 'WhatsApp Contact';
                    formData.notes = 'User clicked WhatsApp contact';
                    logToSignupsSheet(formData);
                    hasLoggedToSheets = true;
                }
                openWhatsApp();
            });
            
            // Close message screen
            document.getElementById('close-message-btn').addEventListener('click', function() {
                window.location.reload();
            });

            // Detect form abandonment - log to Incomplete sheet when user tries to leave
            window.addEventListener('beforeunload', function(e) {
                if (!hasLoggedToSheets && formData.email) {
                    // Log incomplete form data when user tries to leave
                    formData.memberType = formData.memberType || 'Unknown';
                    formData.membershipStatus = formData.membershipStatus || 'Form Abandoned';
                    formData.notes = 'User left form without completing';
                    
                    // Use sendBeacon for better reliability on page unload
                    if (navigator.sendBeacon) {
                        // Create a FormData object with the sheets data
                        const beaconData = new FormData();
                        beaconData.append('action', 'log_to_sheets');
                        beaconData.append('data', JSON.stringify(formData));
                        
                        // Try to send via beacon (works better on unload)
                        navigator.sendBeacon('/log-sheets', beaconData);
                    } else {
                        // Fallback - synchronous request (may not complete)
                        logToIncompleteSheet(formData);
                    }
                    hasLoggedToSheets = true;
                }
            });

            // Also log when page visibility changes (user switches tabs, minimizes window)
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden' && !hasLoggedToSheets && formData.email) {
                    formData.memberType = formData.memberType || 'Unknown';
                    formData.membershipStatus = formData.membershipStatus || 'Form Incomplete';
                    formData.notes = 'User left form (tab hidden/switched)';
                    logToIncompleteSheet(formData);
                    hasLoggedToSheets = true;
                }
            });

            // Fire Snap Pixel VIEW_CONTENT event
            if (typeof snaptr !== 'undefined') {
                snaptr('track', 'VIEW_CONTENT', {
                    'item_category': 'Fitness Membership',
                    'user_email': '__INSERT_USER_EMAIL__',
                    'user_phone_number': '__INSERT_USER_PHONE_NUMBER__'
                });
            }
        });
    </script>
</body>
</html>